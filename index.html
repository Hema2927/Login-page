<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>🌦️ Weather App</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="weather-container">
    <h1>🌤️ Weather App</h1>
    <p id="dateTime"></p>

    <input type="text" id="cityInput" placeholder="Enter city name" />
    <button onclick="getWeather()">Search</button>
    <button onclick="getLocationWeather()">📍 My Location</button>
    <button onclick="toggleTheme()">🌗 Toggle Theme</button>

    <div id="weatherResult"></div>

    <h3>Recent Searches:</h3>
    <ul id="historyList"></ul>
  </div>

  <script>
    const apiKey = "YOUR_OPENWEATHERMAP_API_KEY"; // Replace with your real API key

    const cityInput = document.getElementById("cityInput");
    const weatherDiv = document.getElementById("weatherResult");
    const mapFrame = document.createElement("iframe");
    mapFrame.width = "100%";
    mapFrame.height = "250";
    mapFrame.style.border = "none";
    mapFrame.style.marginTop = "10px";

    function getWeather() {
      const city = cityInput.value.trim();
      if (!city) {
        weatherDiv.innerHTML = "Please enter a city name.";
        return;
      }

      const url = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${apiKey}&units=metric`;
      fetchWeather(url, city);
    }

    function getLocationWeather() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          const { latitude, longitude } = position.coords;
          const url = `https://api.openweathermap.org/data/2.5/weather?lat=${latitude}&lon=${longitude}&appid=${apiKey}&units=metric`;
          fetchWeather(url, "My Location");
        }, () => {
          weatherDiv.innerHTML = "❌ Unable to access your location.";
        });
      } else {
        weatherDiv.innerHTML = "❌ Geolocation not supported.";
      }
    }

    async function fetchWeather(url, cityName) {
      weatherDiv.innerHTML = "🔄 Loading...";
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("City not found.");
        const data = await res.json();

        const { lat, lon } = data.coord;
        const icon = data.weather[0].icon;
        const iconUrl = `https://openweathermap.org/img/wn/${icon}@2x.png`;
        const flagUrl = `https://flagsapi.com/${data.sys.country}/flat/64.png`;

        document.body.style.background = getBackground(data.weather[0].main);
        speak(`Weather in ${data.name} is ${data.weather[0].description} with ${data.main.temp} degrees Celsius.`);

        mapFrame.src = `https://maps.google.com/maps?q=${lat},${lon}&z=10&output=embed`;

        weatherDiv.innerHTML = `
          <h2>${data.name}, ${data.sys.country} <img src="${flagUrl}" width="30"></h2>
          <img src="${iconUrl}" alt="Weather Icon">
          <p><strong>${data.weather[0].main}</strong> - ${data.weather[0].description}</p>
          <p><strong>Temperature:</strong> ${data.main.temp}°C</p>
          <p><strong>Humidity:</strong> ${data.main.humidity}%</p>
          <p><strong>Wind:</strong> ${data.wind.speed} m/s</p>
          <p><strong>Coordinates:</strong> Latitude ${lat}, Longitude ${lon}</p>
        `;

        weatherDiv.appendChild(mapFrame);
        updateHistory(cityName);
        cityInput.value = "";
        weatherDiv.scrollIntoView({ behavior: "smooth" });

      } catch (error) {
        weatherDiv.innerHTML = `❌ ${error.message}`;
      }
    }

    function toggleTheme() {
      document.body.classList.toggle("dark-mode");
    }

    function getBackground(condition) {
      const map = {
        Clear: "#ffe082",
        Clouds: "#90a4ae",
        Rain: "#80deea",
        Thunderstorm: "#b39ddb",
        Snow: "#f0f0f0",
        Mist: "#cfd8dc"
      };
      return map[condition] || "#e0f7fa";
    }

    function updateTime() {
      const now = new Date();
      document.getElementById("dateTime").textContent =
        `📅 ${now.toLocaleDateString()} 🕒 ${now.toLocaleTimeString()}`;
    }
    setInterval(updateTime, 1000);
    updateTime();

    function updateHistory(city) {
      let history = JSON.parse(localStorage.getItem("weatherHistory")) || [];
      if (city && !history.includes(city)) {
        history.unshift(city);
        if (history.length > 5) history.pop();
        localStorage.setItem("weatherHistory", JSON.stringify(history));
      }

      const list = document.getElementById("historyList");
      list.innerHTML = "";
      history.forEach(item => {
        const li = document.createElement("li");
        li.textContent = item;
        li.onclick = () => {
          cityInput.value = item;
          getWeather();
        };
        list.appendChild(li);
      });
    }

    function speak(text) {
      if ('speechSynthesis' in window) {
        const msg = new SpeechSynthesisUtterance(text);
        window.speechSynthesis.speak(msg);
      }
    }

    updateHistory("");
    cityInput.focus();
    cityInput.addEventListener("keydown", e => {
      if (e.key === "Enter") getWeather();
    });
  </script>
</body>
</html>
